<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASTRIONHUB — Room Chat AI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body{
      font-family: Inter, ui-sans-serif, system-ui;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 650px at 85% 15%, rgba(25,211,255,.14), transparent 60%),
        radial-gradient(900px 700px at 40% 92%, rgba(46,229,157,.10), transparent 60%),
        linear-gradient(180deg, #070A12, #0A1020);
      background-color:#070A12;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .bubble{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .bubble-user{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.14);
    }
    .typing-dots{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 0;
    }
    .typing-dots span{
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      display:inline-block;
      animation: blink 1.2s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2){ animation-delay: .15s; opacity:.7; }
    .typing-dots span:nth-child(3){ animation-delay: .30s; opacity:.5; }
    @keyframes blink{
      0%, 80%, 100% { transform: translateY(0); opacity: .35; }
      40% { transform: translateY(-3px); opacity: 1; }
    }
  </style>
</head>

<body class="min-h-screen text-white">
  <div class="mx-auto max-w-5xl px-4 py-6">
    <!-- Topbar -->
    <div class="glass rounded-3xl px-5 py-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 grid place-items-center flex-none">
          <span class="h-6 w-6 text-white/90" data-lucide="bot"></span>
        </div>
        <div class="min-w-0">
          <div class="font-extrabold tracking-tight truncate">Room Chat AI</div>
          <div class="text-xs text-white/55 truncate">Text • Gambar • Musik</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="index.html" class="glass rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition inline-flex items-center gap-2 border border-white/10">
          <span class="h-4 w-4" data-lucide="home"></span>
          Home
        </a>
        <button id="btnClear" class="glass rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition inline-flex items-center gap-2 border border-white/10">
          <span class="h-4 w-4" data-lucide="trash-2"></span>
          Clear
        </button>
      </div>
    </div>

    <!-- Welcome -->
    <div class="mt-5 text-center text-white/65">
      Selamat datang di roomchat AI. Ketik: <span class="text-white/85 font-semibold">buatkan</span> untuk gambar, atau <span class="text-white/85 font-semibold">play/putar</span> untuk musik.
    </div>

    <!-- Chat Area -->
    <div id="chat"
         class="mt-5 glass rounded-3xl border border-white/10 overflow-hidden">
      <div id="chatList" class="p-4 sm:p-6 space-y-3 max-h-[65vh] overflow-auto"></div>

      <!-- Composer -->
      <div class="border-t border-white/10 p-3 sm:p-4 bg-black/10">
        <form id="form" class="flex items-end gap-2">
          <div class="flex-1">
            <textarea id="msg"
              rows="1"
              placeholder="Ketik pesan... (contoh: buatkan cat on the fire / play komang)"
              class="w-full resize-none rounded-2xl bg-white/5 border border-white/10 px-4 py-3 text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-white/15"
            ></textarea>
            <div class="mt-2 text-xs text-white/45">Enter untuk kirim • Shift+Enter untuk baris baru</div>
          </div>

          <button type="submit"
            class="rounded-2xl px-4 py-3 bg-white text-black font-semibold hover:bg-white/90 active:bg-white/80 transition inline-flex items-center gap-2">
            <span class="h-4 w-4" data-lucide="send"></span>
            Kirim
          </button>
        </form>
      </div>
    </div>
  </div>

  <audio id="audio" preload="none"></audio>

  <script>
    // ========= CONFIG (FE-only) =========
    const APIKEY = "sJSCtQ";
    const API_GPT = "https://api.neoxr.eu/api/gpt-pro";
    const API_IMG = "https://api.neoxr.eu/api/ai-anime";
    const API_PLAY = "https://api.neoxr.eu/api/play";

    // ========= UI helpers =========
    const chatList = document.getElementById("chatList");
    const form = document.getElementById("form");
    const msg = document.getElementById("msg");
    const btnClear = document.getElementById("btnClear");
    const audio = document.getElementById("audio");

    lucide.createIcons(); // [web:18]

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function scrollToBottom(){
      chatList.scrollTo({ top: chatList.scrollHeight, behavior: "smooth" });
    }

    function saveChat(){
      localStorage.setItem("astrion_roomchat", chatList.innerHTML);
    }
    function loadChat(){
      const saved = localStorage.getItem("astrion_roomchat");
      if (saved) chatList.innerHTML = saved;
      scrollToBottom();
      lucide.createIcons();
    }

    function bubbleBase(role, innerHtml){
      const isUser = role === "user";
      const align = isUser ? "justify-end" : "justify-start";
      const bubbleClass = isUser ? "bubble bubble-user" : "bubble";
      const label = isUser ? "You" : "AI";
      const icon = isUser ? "user" : "bot";

      const wrap = document.createElement("div");
      wrap.className = `flex ${align}`;
      wrap.innerHTML = `
        <div class="max-w-[92%] sm:max-w-[78%] rounded-3xl ${bubbleClass} px-4 py-3">
          <div class="flex items-center gap-2 text-xs text-white/50 mb-1">
            <span class="h-4 w-4" data-lucide="${icon}"></span>
            <span>${label}</span>
          </div>
          <div class="text-sm sm:text-[15px] leading-relaxed text-white/90 break-words">${innerHtml}</div>
        </div>
      `;
      chatList.appendChild(wrap);
      lucide.createIcons();
      scrollToBottom();
      saveChat();
      return wrap;
    }

    function addText(role, text){
      return bubbleBase(role, esc(text).replaceAll("\n","<br>"));
    }

    function addTyping(){
      const el = bubbleBase("ai", `
        <div class="typing-dots" aria-label="AI typing">
          <span></span><span></span><span></span>
        </div>
      `);
      el.dataset.typing = "1";
      return el;
    }

    function removeTyping(){
      const node = chatList.querySelector('[data-typing="1"]');
      if (node) node.remove();
      saveChat();
    }

    function isImageIntent(t){
      return /(buatkan|bikin|generate|gambar|anime)/i.test(t);
    }
    function isPlayIntent(t){
      return /(play|putar|putarkan)/i.test(t);
    }

    function extractQueryForImage(t){
      // ambil setelah kata kunci, fallback: teks penuh
      const s = t.trim();
      const m = s.match(/(?:buatkan|bikin|generate|gambar|anime)\s+(.+)/i);
      return (m?.[1] || s).trim();
    }

    function extractQueryForPlay(t){
      const s = t.trim();
      // "putarkan lagu komang" / "putar komang" / "play komang"
      const m = s.match(/(?:play|putar|putarkan)(?:\s+lagu)?\s+(.+)/i);
      return (m?.[1] || s).trim();
    }

    async function getJson(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    // ========= Handlers =========
    async function handleGPT(text){
      const url = `${API_GPT}?q=${encodeURIComponent(text)}&apikey=${encodeURIComponent(APIKEY)}`;
      const json = await getJson(url);
      if (!json?.status) throw new Error("API error");
      return json?.data?.message || "Tidak ada jawaban.";
    }

    async function handleImage(prompt){
      const url = `${API_IMG}?q=${encodeURIComponent(prompt)}&apikey=${encodeURIComponent(APIKEY)}`;
      const json = await getJson(url);
      if (!json?.status) throw new Error("API error");
      return { prompt: json?.data?.prompt || prompt, url: json?.data?.url };
    }

    async function handlePlay(query){
      const url = `${API_PLAY}?q=${encodeURIComponent(query)}&apikey=${encodeURIComponent(APIKEY)}`;
      const json = await getJson(url);
      if (!json?.status) throw new Error("API error");
      return {
        title: json?.title,
        channel: json?.channel,
        thumbnail: json?.thumbnail,
        duration: json?.fduration || json?.duration,
        mp3: json?.data?.url,
        filename: json?.data?.filename
      };
    }

    function addImageCard(prompt, imageUrl){
      const html = `
        <div class="text-white/70 text-xs mb-2">Hasil gambar: <span class="text-white/90">${esc(prompt)}</span></div>
        <a href="${esc(imageUrl)}" target="_blank" rel="noopener noreferrer">
          <img src="${esc(imageUrl)}" alt="${esc(prompt)}"
            class="w-full rounded-2xl border border-white/10 bg-white/5" />
        </a>
        <div class="mt-2 flex flex-wrap gap-2">
          <a class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-xs"
             href="${esc(imageUrl)}" target="_blank" rel="noopener noreferrer">
            <span class="h-4 w-4" data-lucide="external-link"></span>
            Buka
          </a>
        </div>
      `;
      bubbleBase("ai", html);
    }

    function addMusicCard(meta){
      const html = `
        <div class="flex gap-3">
          <img src="${esc(meta.thumbnail || "")}" class="h-16 w-24 object-cover rounded-2xl border border-white/10 bg-white/5" alt="thumb" />
          <div class="min-w-0">
            <div class="font-semibold text-white/90 leading-snug">${esc(meta.title || "Untitled")}</div>
            <div class="text-xs text-white/60 mt-1">${esc(meta.channel || "")} • ${esc(meta.duration || "")}</div>
            <div class="text-xs text-white/50 mt-1">${esc(meta.filename || "")}</div>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button data-mp3="${esc(meta.mp3 || "")}"
            class="btnPlay inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-white text-black hover:bg-white/90 transition text-xs font-semibold">
            <span class="h-4 w-4" data-lucide="play"></span>
            Play
          </button>

          <a class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-xs"
             href="${esc(meta.mp3 || "")}" target="_blank" rel="noopener noreferrer">
            <span class="h-4 w-4" data-lucide="download"></span>
            Download
          </a>
        </div>
      `;
      bubbleBase("ai", html);

      // bind play buttons
      chatList.querySelectorAll(".btnPlay").forEach(btn => {
        if (btn.dataset.bound) return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async () => {
          const url = btn.getAttribute("data-mp3");
          if (!url) return;

          try{
            audio.src = url;
            await audio.play(); // audio playback via <audio> element [web:554]
            btn.innerHTML = `<span class="h-4 w-4" data-lucide="pause"></span> Playing`;
            lucide.createIcons();
          }catch(e){
            addText("ai", "Browser menolak autoplay. Klik lagi atau pastikan audio diizinkan.");
          }
        });
      });

      lucide.createIcons();
    }

    // ========= Events =========
    msg.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    btnClear.addEventListener("click", () => {
      chatList.innerHTML = "";
      localStorage.removeItem("astrion_roomchat");
      addText("ai", "Chat dibersihkan.");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = msg.value.trim();
      if (!text) return;

      msg.value = "";
      msg.style.height = "";
      addText("user", text);

      const typing = addTyping();

      try{
        if (isImageIntent(text)) {
          // auto response dulu
          removeTyping();
          addText("ai", "Baik, tunggu sebentar ya...");
          const prompt = extractQueryForImage(text);

          const t2 = addTyping();
          const img = await handleImage(prompt);
          removeTyping();
          addImageCard(img.prompt, img.url);
        }
        else if (isPlayIntent(text)) {
          const q = extractQueryForPlay(text);
          const song = await handlePlay(q);
          removeTyping();
          addMusicCard(song);
        }
        else {
          const ans = await handleGPT(text);
          removeTyping();
          addText("ai", ans);
        }
      }catch(err){
        removeTyping();
        addText("ai", "Error: " + (err?.message || err));
      }
    });

    // auto grow textarea
    msg.addEventListener("input", () => {
      msg.style.height = "auto";
      msg.style.height = Math.min(msg.scrollHeight, 180) + "px";
    });

    // init
    loadChat();
    if (!chatList.innerHTML.trim()) {
      addText("ai", "Halo! Ketik pesan apa saja. Contoh: 'buatkan cat on the fire' atau 'play komang'.");
    }
  </script>
</body>
</html>
