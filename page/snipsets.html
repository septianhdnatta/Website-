<!-- FILE: snipsets.html (UPDATED: syntax highlight + 16:9 modal code, NO love) -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASTRIONHUB — Code Snipsets</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- highlight.js (syntax highlighting) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "ui-sans-serif", "system-ui"],
            mono: ["JetBrains Mono", "ui-monospace", "SFMono-Regular"]
          }
        }
      }
    }
  </script>

  <style>
    :root{ --bg0:#070A12; --bg1:#0A1020; }
    html{ scroll-behavior:smooth; }
    body{
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(900px 650px at 85% 15%, rgba(25,211,255,.14), transparent 60%),
        radial-gradient(900px 700px at 40% 92%, rgba(46,229,157,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      background-color:#070A12;
    }

    .bg-grid{
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 44px 44px;
      opacity: .22;
    }
    .bg-vignette{
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: radial-gradient(70% 55% at 50% 35%, transparent 0%, rgba(0,0,0,.25) 60%, rgba(0,0,0,.58) 100%);
    }
    .app{ position: relative; z-index: 1; }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .glass-strong{
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.055));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset, 0 20px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .g-border{
      position: relative;
      border-radius: 16px;
      padding: 1px;
      overflow: hidden;
      background: linear-gradient(120deg,
        rgba(124,92,255,.55),
        rgba(25,211,255,.35),
        rgba(46,229,157,.25),
        rgba(255,255,255,.10)
      );
    }
    .g-border > .inner{
      border-radius: 15px;
      background: linear-gradient(180deg, rgba(10,16,32,.85), rgba(7,10,18,.72));
      border: 1px solid rgba(255,255,255,.10);
    }

    .btn-shine{ position:relative; overflow:hidden; }
    .btn-shine::after{
      content:"";
      position:absolute; top:-30%; left:-60%;
      width:50%; height:160%;
      transform: rotate(18deg);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      animation: shine 2.6s ease-in-out infinite;
      opacity: .55;
    }
    @keyframes shine { 0%{ transform:translateX(-120%) rotate(18deg);} 100%{ transform:translateX(120%) rotate(18deg);} }

    .reveal{ opacity:0; transform: translateY(12px); transition: opacity .7s ease, transform .7s ease; }
    .reveal.show{ opacity:1; transform: translateY(0); }

    .mono{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .scrollbar::-webkit-scrollbar{ width: 10px; height: 10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); border-radius: 999px; }

    /* Code preview fade (card) */
    .code-fade{ position: relative; }
    .code-fade::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height: 46px;
      background: linear-gradient(180deg, rgba(7,10,18,0), rgba(7,10,18,.92));
      pointer-events:none;
    }

    /* 16:9 wrapper (modal) */
    .aspect-16x9{ aspect-ratio: 16 / 9; }
    @supports not (aspect-ratio: 16 / 9){
      .aspect-16x9{ position: relative; }
      .aspect-16x9::before{ content:""; display:block; padding-top:56.25%; }
      .aspect-16x9 > .aspect-inner{ position:absolute; inset:0; }
    }

    /* hljs tweak (keep bg consistent) */
    pre code.hljs{ background: transparent !important; }
  </style>
</head>

<body class="text-white font-sans selection:bg-white/15 selection:text-white overflow-x-hidden min-h-screen bg-[#070A12]">
  <div class="bg-grid"></div>
  <div class="bg-vignette"></div>

  <div class="app">
    <!-- NAV -->
    <header class="sticky top-0 z-50">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
        <nav class="glass rounded-2xl px-4 sm:px-5 py-3 flex items-center justify-between max-w-full">
          <a href="index.html" class="flex items-center gap-3 min-w-0">
            <div class="g-border h-10 w-10 rounded-xl overflow-hidden grid place-items-center flex-none">
              <div class="inner h-full w-full grid place-items-center">
                <div class="h-6 w-6 text-white/90" data-lucide="sparkles"></div>
              </div>
            </div>
            <div class="leading-tight min-w-0">
              <div class="text-sm text-white/85 font-semibold truncate">ASTRIONHUB</div>
              <div class="text-xs text-white/50 truncate">Code Snipsets</div>
            </div>
          </a>

          <div class="hidden md:flex items-center gap-6 text-sm text-white/75">
            <a class="hover:text-white transition" href="/">Home</a>
            <a class="hover:text-white transition" href="features.html">Features</a>
            <a class="hover:text-white transition" href="snipsets.html">Snipsets</a>
            <a class="hover:text-white transition" href="demo.html">Demo</a>
            <a class="hover:text-white transition" href="pricing.html">Pricing</a>
            <a class="hover:text-white transition" href="snipsets.html">Code</a>
            <a class="hover:text-white transition" href="contact.html">Contact</a>
          </div>

          <button id="btnMenu" class="md:hidden inline-flex items-center justify-center h-10 w-10 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 transition" aria-label="Open menu">
            <span class="h-5 w-5" data-lucide="menu"></span>
          </button>
        </nav>

        <div id="mobileMenu" class="hidden md:hidden mt-3 glass rounded-2xl px-4 py-3 max-w-full">
          <div class="grid gap-1 text-sm text-white/80">
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="index.html">Home</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="features.html">Features</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="snipsets.html">Snipsets</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="demo.html">Demo</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="pricing.html">Pricing</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="snipsets.html">Code</a>
            <a class="px-3 py-2 rounded-xl hover:bg-white/7 transition" href="contact.html">Contact</a>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-10 pb-14">
      <section class="reveal">
        <div class="g-border w-full max-w-full">
          <div class="inner glass-strong rounded-2xl p-6 sm:p-8 w-full max-w-full">
            <div class="flex items-start justify-between gap-4 flex-wrap min-w-0">
              <div class="min-w-0">
                <div class="text-xs text-white/55">Code Snipsets</div>
                <h1 class="mt-2 text-3xl sm:text-4xl font-extrabold tracking-tight">Library kode fitur</h1>
                <p class="mt-3 text-white/70 max-w-2xl">
                  Klik card untuk lihat kode lengkap + tombol copy. Preview akan “setengah” supaya deskripsi tetap kelihatan.
                </p>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <button id="btnRefresh"
                  class="inline-flex w-full sm:w-auto items-center justify-center gap-2 px-4 py-2.5 rounded-2xl border border-white/12 bg-white/5 hover:bg-white/8 transition">
                  <span class="h-4 w-4" data-lucide="refresh-cw"></span>
                  <span class="text-sm font-semibold">Refresh</span>
                </button>

                <button id="btnResetMarks"
                  class="btn-shine inline-flex w-full sm:w-auto items-center justify-center gap-2 px-4 py-2.5 rounded-2xl bg-white text-black hover:bg-white/90 transition">
                  <span class="h-4 w-4" data-lucide="badge-check"></span>
                  <span class="text-sm font-semibold">Reset NEW/UPD</span>
                </button>

                <button id="btnOpenJson"
                  class="inline-flex w-full sm:w-auto items-center justify-center gap-2 px-4 py-2.5 rounded-2xl border border-white/12 bg-white/5 hover:bg-white/8 transition">
                  <span class="h-4 w-4" data-lucide="link"></span>
                  <span class="text-sm font-semibold">JSON</span>
                </button>
              </div>
            </div>

            <!-- Search + Filters -->
            <div class="mt-6 grid lg:grid-cols-12 gap-3 min-w-0">
              <div class="lg:col-span-7 min-w-0">
                <div class="glass rounded-2xl border border-white/10 px-4 py-3 flex items-center gap-3 min-w-0">
                  <span class="h-4 w-4 text-white/60 flex-none" data-lucide="search"></span>
                  <input id="q"
                    class="w-full bg-transparent outline-none text-sm text-white/90 placeholder:text-white/35 min-w-0"
                    placeholder="Cari nama fitur, deskripsi, versi, atau isi code..." />
                  <button id="btnClear"
                    class="inline-flex items-center justify-center h-9 w-9 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 transition flex-none"
                    aria-label="Clear">
                    <span class="h-4 w-4" data-lucide="x"></span>
                  </button>
                </div>
              </div>

              <div class="lg:col-span-5 min-w-0">
                <div class="glass rounded-2xl border border-white/10 px-3 py-2.5 flex flex-wrap gap-2 items-center">
                  <button data-filter="all" class="chip px-3 py-1.5 rounded-full text-sm border border-white/10 bg-white text-black font-semibold">All</button>
                  <button data-filter="case" class="chip px-3 py-1.5 rounded-full text-sm border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/80">Case</button>
                  <button data-filter="cjs" class="chip px-3 py-1.5 rounded-full text-sm border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/80">Plugin CJS</button>
                  <button data-filter="esm" class="chip px-3 py-1.5 rounded-full text-sm border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/80">Plugin ESM</button>
                  <span class="ml-auto text-xs text-white/50" id="resultMeta">0</span>
                </div>
              </div>
            </div>

            <!-- STATS -->
            <div class="mt-5 grid grid-cols-2 lg:grid-cols-6 gap-3">
              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="layers"></span>Total</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-emerald-400"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statTotal">0</div>
              </div>

              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="sparkles"></span>New</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-cyan-300"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statNew">0</div>
                <div class="mt-2 text-[11px] text-white/45">TTL 24h</div>
              </div>

              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="arrow-up-right"></span>Updated</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-violet-300"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statUpd">0</div>
                <div class="mt-2 text-[11px] text-white/45">Hash detect</div>
              </div>

              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="braces"></span>Case</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-sky-300"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statCase">0</div>
              </div>

              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="box"></span>CJS</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-amber-300"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statCjs">0</div>
              </div>

              <div class="glass rounded-2xl border border-white/10 p-4">
                <div class="flex items-center justify-between text-xs text-white/60">
                  <span class="inline-flex items-center gap-2"><span class="h-4 w-4" data-lucide="package"></span>ESM</span>
                  <span class="h-2.5 w-2.5 rounded-full bg-teal-300"></span>
                </div>
                <div class="mt-3 text-3xl font-extrabold tracking-tight" id="statEsm">0</div>
              </div>
            </div>

            <!-- STATES -->
            <div id="stateLoading" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="glass rounded-2xl border border-white/10 p-5 animate-pulse">
                <div class="h-5 w-32 bg-white/10 rounded"></div>
                <div class="mt-3 h-4 w-full bg-white/8 rounded"></div>
                <div class="mt-2 h-4 w-5/6 bg-white/8 rounded"></div>
                <div class="mt-4 h-28 w-full bg-white/6 rounded-2xl"></div>
              </div>
              <div class="glass rounded-2xl border border-white/10 p-5 animate-pulse">
                <div class="h-5 w-28 bg-white/10 rounded"></div>
                <div class="mt-3 h-4 w-full bg-white/8 rounded"></div>
                <div class="mt-2 h-4 w-2/3 bg-white/8 rounded"></div>
                <div class="mt-4 h-28 w-full bg-white/6 rounded-2xl"></div>
              </div>
              <div class="glass rounded-2xl border border-white/10 p-5 animate-pulse">
                <div class="h-5 w-36 bg-white/10 rounded"></div>
                <div class="mt-3 h-4 w-full bg-white/8 rounded"></div>
                <div class="mt-2 h-4 w-4/5 bg-white/8 rounded"></div>
                <div class="mt-4 h-28 w-full bg-white/6 rounded-2xl"></div>
              </div>
            </div>

            <div id="stateError" class="hidden mt-6 glass rounded-2xl border border-rose-300/15 bg-rose-500/10 p-5">
              <div class="flex items-start gap-3 min-w-0">
                <span class="h-5 w-5 text-rose-200 flex-none" data-lucide="triangle-alert"></span>
                <div class="min-w-0">
                  <div class="font-semibold text-rose-100">Gagal load snipsets.json</div>
                  <div id="errorText" class="mt-1 text-sm text-rose-100/80 break-all"></div>
                </div>
              </div>
            </div>

            <div id="stateEmpty" class="hidden mt-6 glass rounded-2xl border border-white/10 p-5">
              <div class="flex items-start gap-3 min-w-0">
                <span class="h-5 w-5 text-white/70 flex-none" data-lucide="inbox"></span>
                <div class="min-w-0">
                  <div class="font-semibold text-white/85">Belum ada snipsets</div>
                  <div class="mt-1 text-sm text-white/65">Isi JSON dulu, nanti otomatis tampil di sini.</div>
                </div>
              </div>
            </div>

            <!-- GRID -->
            <div id="grid" class="hidden mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 min-w-0"></div>
          </div>
        </div>
      </section>
    </main>

    <footer class="border-t border-white/10">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
        <div class="text-sm text-white/55">© <span id="year"></span> ASTRIONHUB</div>
        <div class="flex flex-wrap gap-2 text-sm">
          <a href="index.html" class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/70">Home</a>
          <a href="features.html" class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/70">Features</a>
          <a href="pricing.html" class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/70">Pricing</a>
          <a href="contact.html" class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 hover:bg-white/8 transition text-white/70">Contact</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 z-[999]">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/70"></div>

    <div class="relative mx-auto max-w-5xl w-full px-4 sm:px-6 lg:px-8 py-10">
      <div class="g-border w-full max-w-full">
        <div class="inner glass-strong rounded-2xl p-5 sm:p-6 w-full max-w-full overflow-hidden">
          <div class="flex items-start justify-between gap-3 min-w-0">
            <div class="min-w-0">
              <div class="text-xs text-white/55">Snippet</div>
              <div class="mt-1 flex items-center gap-2 min-w-0">
                <div id="mTitle" class="text-xl sm:text-2xl font-extrabold tracking-tight truncate">—</div>
                <span id="mBadges" class="flex items-center gap-2 flex-none"></span>
              </div>
              <div id="mMeta" class="mt-1 text-sm text-white/55 break-all"></div>
            </div>

            <button id="btnClose"
              class="inline-flex items-center justify-center h-10 w-10 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 transition flex-none"
              aria-label="Close">
              <span class="h-5 w-5" data-lucide="x"></span>
            </button>
          </div>

          <!-- Tabs -->
          <div class="mt-4 flex flex-wrap gap-2" id="tabs"></div>

          <!-- Code area (16:9) -->
          <div class="mt-4 glass rounded-2xl border border-white/10 overflow-hidden w-full max-w-full">
            <div class="flex items-center justify-between gap-2 px-4 py-3 border-b border-white/10 bg-white/5">
              <div class="flex items-center gap-2 text-sm text-white/80 min-w-0">
                <span class="h-4 w-4 flex-none" data-lucide="code-2"></span>
                <span id="mTabLabel" class="font-semibold truncate">Code</span>
              </div>
              <button id="btnCopy"
                class="btn-shine inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-full bg-white text-black hover:bg-white/90 transition text-sm font-semibold flex-none">
                <span class="h-4 w-4" data-lucide="copy"></span>
                Copy
              </button>
            </div>

            <div class="aspect-16x9 bg-[#070A12]">
              <div class="aspect-inner">
                <pre class="mono text-[12px] sm:text-[13px] leading-relaxed p-0 m-0 overflow-auto h-full scrollbar">
<code id="mCode" class="language-javascript hljs block p-4"></code></pre>
              </div>
            </div>
          </div>

          <div class="mt-4 glass rounded-2xl border border-white/10 p-4">
            <div class="flex items-start gap-3 min-w-0">
              <span class="h-5 w-5 text-white/70 flex-none" data-lucide="align-left"></span>
              <div class="min-w-0">
                <div class="text-sm font-semibold text-white/85">Deskripsi</div>
                <div id="mDesc" class="mt-1 text-sm text-white/70 break-words">—</div>
              </div>
            </div>
          </div>

          <div id="toast" class="hidden mt-3 text-sm text-white/70"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const JSON_URLS = [
      "https://raw.githubusercontent.com/septianhdnatta/Website-/refs/heads/main/db/snipsets.json",
      "https://raw.githubusercontent.com/septianhdnatta/Website-/main/db/snipsets.json"
    ];

    const NEW_TTL_MS = 24 * 60 * 60 * 1000;
    const UPDATED_TTL_MS = 7 * 24 * 60 * 60 * 1000;

    const SEEN_KEY = "astrionhub_snipsets_seen_ts_v2";
    const HASH_KEY = "astrionhub_snipsets_hash_v2";
    const UPDATED_KEY = "astrionhub_snipsets_updated_ts_v2";

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const safeText = (v, fallback="") => (v === null || v === undefined) ? fallback : String(v);

    function escapeHTML(str) {
      const s = safeText(str, "");
      return s.replace(/[&<>"']/g, (ch) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[ch]));
    }

    function normalizeItems(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.snipsets)) return data.snipsets;
      if (data && Array.isArray(data.snippets)) return data.snippets;
      if (data && Array.isArray(data.items)) return data.items;
      if (data && Array.isArray(data.data)) return data.data;
      return [];
    }

    function toCodeString(v) {
      if (v === null || v === undefined) return "";
      if (Array.isArray(v)) return v.map(x => safeText(x)).join("\n");
      if (typeof v === "object") {
        if (typeof v.code === "string") return v.code;
        try { return JSON.stringify(v, null, 2); } catch { return String(v); }
      }
      return String(v);
    }

    function getKey(item, idx) {
      const k = item.id ?? item.key ?? item.slug ?? item.name ?? item.title ?? item.feature ?? idx;
      return safeText(k, idx).trim();
    }

    function pickTitle(item) {
      return safeText(item.title ?? item.name ?? item.feature ?? item.id ?? "Untitled");
    }

    function pickDesc(item) {
      return safeText(item.description ?? item.desc ?? item.detail ?? item.notes ?? "");
    }

    function pickVersion(item) {
      return safeText(item.version ?? item.ver ?? item.v ?? "");
    }

    function pickIcon(item) {
      return safeText(item.icon ?? item.lucide ?? item.ico ?? "code-2").trim() || "code-2";
    }

    function getTypeGuess(item) {
      const t = safeText(item.type ?? item.kind ?? item.category ?? "").toLowerCase().trim();
      if (["case","cjs","esm"].includes(t)) return t;
      return "all";
    }

    function extractVariants(item) {
      const out = [];
      const add = (id, label, code, hintType) => {
        const c = toCodeString(code);
        if (!c.trim()) return;
        out.push({ id, label, type: hintType || id, code: c });
      };

      const variants = item.variants;
      if (variants && typeof variants === "object" && !Array.isArray(variants)) {
        for (const [k, v] of Object.entries(variants)) {
          const kk = String(k).trim();
          add(kk.toLowerCase(), kk.toUpperCase(), v, kk.toLowerCase());
        }
      }

      const code = item.code;
      if (code && typeof code === "object" && !Array.isArray(code)) {
        add("case", "Case", code.case ?? code.example ?? code.sample ?? "", "case");
        add("cjs", "Plugin CJS", code.cjs ?? code.plugin_cjs ?? code["plugin cjs"] ?? "", "cjs");
        add("esm", "Plugin ESM", code.esm ?? code.plugin_esm ?? code["plugin esm"] ?? "", "esm");
        for (const [k, v] of Object.entries(code)) {
          const kk = String(k).toLowerCase();
          if (["case","example","sample","cjs","esm","plugin_cjs","plugin_esm","plugin cjs","plugin esm"].includes(kk)) continue;
          add(kk, k, v, kk);
        }
      } else if (typeof code === "string") {
        add("code", "Code", code, getTypeGuess(item));
      }

      add("case", "Case", item.case ?? item.example ?? item.sample ?? "", "case");
      add("cjs", "Plugin CJS", item.cjs ?? item.plugin_cjs ?? item.pluginCjs ?? item["plugin cjs"] ?? "", "cjs");
      add("esm", "Plugin ESM", item.esm ?? item.plugin_esm ?? item.pluginEsm ?? item["plugin esm"] ?? "", "esm");

      const seen = new Set();
      return out.filter(v => (seen.has(v.id) ? false : (seen.add(v.id), true)));
    }

    function linesPreview(code, maxLines = 10) {
      const s = toCodeString(code);
      const lines = s.split("\n");
      return lines.slice(0, maxLines).join("\n");
    }

    function msToAge(ms) {
      const sec = Math.max(0, Math.floor(ms / 1000));
      const m = Math.floor(sec / 60);
      const h = Math.floor(m / 60);
      const d = Math.floor(h / 24);
      if (d > 0) return `${d}d`;
      if (h > 0) return `${h}h`;
      if (m > 0) return `${m}m`;
      return `${sec}s`;
    }

    function lsGet(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const v = JSON.parse(raw);
        return (v && typeof v === "object") ? v : fallback;
      } catch { return fallback; }
    }

    function lsSet(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }

    function hashStr(str) {
      const s = String(str);
      let h = 2166136261;
      for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0).toString(16);
    }

    function itemHash(item, variants) {
      const base = [
        pickTitle(item),
        pickDesc(item),
        pickVersion(item),
        safeText(item.type ?? item.kind ?? ""),
        variants.map(v => v.id + ":" + v.code).join("\n---\n")
      ].join("\n#\n");
      return hashStr(base);
    }

    function show(el, yes) { el.classList.toggle("hidden", !yes); }

    function badgeNew(ageMs) {
      const age = msToAge(ageMs);
      const isNew = ageMs <= NEW_TTL_MS;
      const label = isNew ? "NEW" : age;
      const cls = isNew
        ? "bg-cyan-400/12 border-cyan-300/15 text-cyan-100"
        : "bg-cyan-400/8 border-cyan-300/10 text-cyan-100/75";
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold border ${cls}">${label}</span>`;
    }

    function badgeUpd(ageMs) {
      const age = msToAge(ageMs);
      const isHot = ageMs <= UPDATED_TTL_MS;
      const label = isHot ? "UPD" : age;
      const cls = isHot
        ? "bg-violet-400/12 border-violet-300/15 text-violet-100"
        : "bg-violet-400/8 border-violet-300/10 text-violet-100/75";
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold border ${cls}">${label}</span>`;
    }

    function badgeType(type) {
      if (type === "case") return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-sky-400/10 border border-sky-300/15 text-sky-100">CASE</span>`;
      if (type === "cjs") return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-amber-400/10 border border-amber-300/15 text-amber-100">CJS</span>`;
      if (type === "esm") return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-teal-400/10 border border-teal-300/15 text-teal-100">ESM</span>`;
      return "";
    }

    // ===== Fetch JSON =====
    async function fetchFirstWorkingJson() {
      let lastErr = null;
      for (const base of JSON_URLS) {
        try {
          const url = base + (base.includes("?") ? "&" : "?") + "t=" + Date.now();
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          const lastModified = res.headers.get("last-modified");
          const data = await res.json();
          return { base, data, lastModified };
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("Fetch failed");
    }

    // ===== State =====
    const state = {
      items: [],
      view: [],
      q: "",
      filter: "all",
      lastModified: "",
      baseUrl: ""
    };

    // ===== Render card =====
    function renderCard(it) {
      const title = escapeHTML(it.title);
      const desc = escapeHTML(it.desc || "—");
      const icon = escapeHTML(it.icon || "code-2");

      const badges = [
        it.newAgeMs != null ? badgeNew(it.newAgeMs) : "",
        it.updAgeMs != null ? badgeUpd(it.updAgeMs) : "",
        it.typeBadge ? it.typeBadge : ""
      ].filter(Boolean).join("");

      const meta = [
        it.version ? `v${escapeHTML(it.version)}` : "",
        it.variants?.length ? `${it.variants.length} variant` : ""
      ].filter(Boolean).join(" • ");

      const preview = escapeHTML(linesPreview(it.previewCode, 7));

      return `
        <button data-open="${escapeHTML(it.key)}"
          class="text-left glass rounded-2xl border border-white/10 p-5 w-full max-w-full overflow-hidden hover:bg-white/7 hover:border-white/20 transition">
          <div class="flex items-start justify-between gap-3 min-w-0">
            <div class="flex items-start gap-3 min-w-0">
              <div class="h-10 w-10 rounded-2xl border border-white/10 bg-white/5 grid place-items-center flex-none">
                <span class="h-5 w-5 text-white/85" data-lucide="${icon}"></span>
              </div>
              <div class="min-w-0">
                <div class="font-semibold text-white/90 truncate min-w-0">${title}</div>
                <div class="mt-1 text-xs text-white/55 break-all">${meta || ""}</div>
              </div>
            </div>

            <div class="flex items-center gap-2 flex-wrap justify-end flex-none">
              ${badges}
              <span class="h-4 w-4 text-white/55" data-lucide="arrow-up-right"></span>
            </div>
          </div>

          <div class="mt-4 glass rounded-2xl border border-white/10 bg-[#070A12] overflow-hidden w-full max-w-full">
            <div class="code-fade">
              <pre class="p-0 m-0 overflow-hidden max-h-[110px] sm:max-h-[160px]">
<code class="language-javascript text-[12px] leading-relaxed block p-4">${preview}</code></pre>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-sm text-white/70 break-words">${desc}</div>
          </div>
        </button>
      `;
    }

    // ===== Modal =====
    const modal = $("modal");
    const modalBackdrop = $("modalBackdrop");
    const btnClose = $("btnClose");
    const btnCopy = $("btnCopy");
    const mTitle = $("mTitle");
    const mDesc = $("mDesc");
    const mCode = $("mCode");
    const mMeta = $("mMeta");
    const mBadges = $("mBadges");
    const tabs = $("tabs");
    const mTabLabel = $("mTabLabel");
    const toast = $("toast");

    let modalItem = null;
    let modalVariant = null;

    function toastMsg(msg) {
      toast.textContent = msg;
      toast.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.add("hidden"), 2200);
    }

    function openModal(key) {
      const it = state.items.find(x => x.key === key);
      if (!it) return;

      modalItem = it;
      modalVariant = it.variants[0] || { id: "code", label: "Code", code: it.previewCode || "" };

      mTitle.textContent = it.title;
      mDesc.textContent = it.desc || "—";

      const meta = [
        it.version ? `v${it.version}` : "",
        it.variants?.length ? `${it.variants.length} variant` : ""
      ].filter(Boolean).join(" • ");
      mMeta.textContent = meta;

      const bb = [];
      if (it.newAgeMs != null) bb.push(badgeNew(it.newAgeMs));
      if (it.updAgeMs != null) bb.push(badgeUpd(it.updAgeMs));
      mBadges.innerHTML = bb.join("");

      // tabs
      tabs.innerHTML = "";
      for (const v of it.variants) {
        const active = (v.id === modalVariant.id);
        const btn = document.createElement("button");
        btn.className = "px-3 py-1.5 rounded-full text-sm border border-white/10 transition " +
          (active ? "bg-white text-black font-semibold" : "bg-white/5 hover:bg-white/8 text-white/80");
        btn.textContent = v.label;
        btn.onclick = () => setModalVariant(v.id);
        tabs.appendChild(btn);
      }

      setModalVariant(modalVariant.id);

      show(modal, true);
      document.body.classList.add("overflow-hidden");
      lucide.createIcons();
    }

    function closeModal() {
      show(modal, false);
      document.body.classList.remove("overflow-hidden");
      modalItem = null;
      modalVariant = null;
    }

    function setModalVariant(variantId) {
      if (!modalItem) return;
      const v = modalItem.variants.find(x => x.id === variantId) || modalItem.variants[0];
      modalVariant = v;

      mTabLabel.textContent = v?.label || "Code";
      mCode.textContent = v?.code || "";

      // highlight modal code
      try { hljs.highlightElement(mCode); } catch {}

      // refresh tab active styles
      [...tabs.children].forEach((b) => {
        const active = (b.textContent === (v?.label || "Code"));
        b.className = "px-3 py-1.5 rounded-full text-sm border border-white/10 transition " +
          (active ? "bg-white text-black font-semibold" : "bg-white/5 hover:bg-white/8 text-white/80");
      });
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return ok;
        } catch {
          return false;
        }
      }
    }

    btnCopy.addEventListener("click", async () => {
      const txt = modalVariant?.code || "";
      const ok = await copyToClipboard(txt);
      toastMsg(ok ? "Copied." : "Copy failed.");
    });

    btnClose.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modal.classList.contains("hidden")) closeModal();
    });

    // ===== Search & Filter =====
    function normalizeQuery(s) {
      return safeText(s, "").toLowerCase().trim();
    }

    function searchableText(it) {
      const vtxt = (it.variants || []).map(v => v.code).join("\n");
      return normalizeQuery([it.title, it.desc, it.version, it.typeGuess, vtxt].join("\n"));
    }

    function applyView() {
      const q = normalizeQuery(state.q);
      const f = state.filter;

      const view = state.items.filter(it => {
        if (f !== "all") {
          const has = it.variants.some(v => v.type === f || v.id === f);
          if (!has) return false;
        }
        if (!q) return true;
        return it.searchText.includes(q);
      });

      state.view = view;
      $("resultMeta").textContent = `${view.length}/${state.items.length}`;

      const grid = $("grid");
      grid.innerHTML = view.map(renderCard).join("");
      show(grid, true);

      // bind open
      grid.querySelectorAll("[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.getAttribute("data-open")));
      });

      // icons + highlight after DOM injection
      lucide.createIcons();
      try {
        grid.querySelectorAll("pre code").forEach(el => hljs.highlightElement(el));
      } catch {}
    }

    // ===== Stats =====
    function updateStats() {
      const total = state.items.length;
      const nNew = state.items.filter(x => x.newAgeMs != null && x.newAgeMs <= NEW_TTL_MS).length;
      const nUpd = state.items.filter(x => x.updAgeMs != null && x.updAgeMs <= UPDATED_TTL_MS).length;

      const nCase = state.items.filter(x => x.variants.some(v => v.type === "case" || v.id === "case")).length;
      const nCjs = state.items.filter(x => x.variants.some(v => v.type === "cjs" || v.id === "cjs")).length;
      const nEsm = state.items.filter(x => x.variants.some(v => v.type === "esm" || v.id === "esm")).length;

      $("statTotal").textContent = String(total);
      $("statNew").textContent = String(nNew);
      $("statUpd").textContent = String(nUpd);
      $("statCase").textContent = String(nCase);
      $("statCjs").textContent = String(nCjs);
      $("statEsm").textContent = String(nEsm);
    }

    // ===== Load =====
    async function loadSnipsets() {
      show($("stateLoading"), true);
      show($("stateError"), false);
      show($("stateEmpty"), false);
      show($("grid"), false);
      $("grid").innerHTML = "";

      const now = Date.now();
      let seenMap = lsGet(SEEN_KEY, {});
      let hashMap = lsGet(HASH_KEY, {});
      let updMap = lsGet(UPDATED_KEY, {});

      // prune updated map older than TTL
      const updPruned = {};
      for (const [k, ts] of Object.entries(updMap)) {
        const n = Number(ts);
        if (Number.isFinite(n) && (now - n) <= UPDATED_TTL_MS) updPruned[k] = n;
      }
      updMap = updPruned;

      try {
        const { base, data, lastModified } = await fetchFirstWorkingJson();
        state.baseUrl = base;
        state.lastModified = lastModified || "";
        $("btnOpenJson").onclick = () => window.open(base, "_blank", "noopener,noreferrer");

        const raw = normalizeItems(data);
        if (!raw.length) {
          show($("stateLoading"), false);
          show($("stateEmpty"), true);
          state.items = [];
          updateStats();
          applyView();
          return;
        }

        const items = raw.map((item, idx) => {
          const key = getKey(item, idx);

          if (seenMap[key] === undefined) seenMap[key] = now;

          const variants = extractVariants(item);
          const h = itemHash(item, variants);

          const oldHash = hashMap[key];
          if (oldHash && oldHash !== h) {
            updMap[key] = now;
          }
          hashMap[key] = h;

          const title = pickTitle(item);
          const desc = pickDesc(item);
          const version = pickVersion(item);
          const icon = pickIcon(item);

          const firstSeen = Number(seenMap[key] ?? now);
          const newAgeMs = now - firstSeen;

          const updTs = updMap[key] !== undefined ? Number(updMap[key]) : null;
          const updAgeMs = (updTs != null && Number.isFinite(updTs)) ? (now - updTs) : null;

          const tGuess = getTypeGuess(item);
          const typeBadge = (tGuess === "case" || tGuess === "cjs" || tGuess === "esm") ? badgeType(tGuess) : "";

          const previewVariant =
            variants.find(v => v.id === "case") ||
            variants[0] ||
            { id:"code", label:"Code", type:tGuess, code: toCodeString(item.code ?? "") };

          const previewCode = previewVariant.code;

          const out = {
            key,
            title,
            desc,
            version,
            icon,
            variants,
            previewCode,
            typeGuess: tGuess,
            typeBadge,
            newAgeMs,
            updAgeMs
          };

          out.searchText = searchableText(out);
          return out;
        });

        // Sort: NEW first, then UPDATED, then alpha
        items.sort((a, b) => {
          const aNew = (a.newAgeMs ?? 1e18);
          const bNew = (b.newAgeMs ?? 1e18);
          const aIsNew = aNew <= NEW_TTL_MS;
          const bIsNew = bNew <= NEW_TTL_MS;
          if (aIsNew !== bIsNew) return aIsNew ? -1 : 1;

          const aUpd = (a.updAgeMs ?? 1e18);
          const bUpd = (b.updAgeMs ?? 1e18);
          const aIsUpd = aUpd <= UPDATED_TTL_MS;
          const bIsUpd = bUpd <= UPDATED_TTL_MS;
          if (aIsUpd !== bIsUpd) return aIsUpd ? -1 : 1;

          return a.title.localeCompare(b.title);
        });

        // persist
        lsSet(SEEN_KEY, seenMap);
        lsSet(HASH_KEY, hashMap);
        lsSet(UPDATED_KEY, updMap);

        state.items = items;

        show($("stateLoading"), false);
        show($("grid"), true);

        updateStats();
        applyView();
      } catch (e) {
        show($("stateLoading"), false);
        show($("stateError"), true);
        $("errorText").textContent = e?.message ? String(e.message) : "Unknown error";
        state.items = [];
        updateStats();
        applyView();
      }
    }

    // ===== Boot =====
    (function boot() {
      lucide.createIcons();

      $("year").textContent = new Date().getFullYear();

      // menu
      const btnMenu = $("btnMenu");
      const mobileMenu = $("mobileMenu");
      btnMenu?.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
      mobileMenu?.querySelectorAll("a").forEach(a => a.addEventListener("click", () => mobileMenu.classList.add("hidden")));

      // search
      $("q").addEventListener("input", (e) => {
        state.q = e.target.value;
        applyView();
      });

      $("btnClear").addEventListener("click", () => {
        $("q").value = "";
        state.q = "";
        applyView();
      });

      // filters
      document.querySelectorAll(".chip").forEach(btn => {
        btn.addEventListener("click", () => {
          state.filter = btn.dataset.filter || "all";

          document.querySelectorAll(".chip").forEach(b => {
            const active = (b === btn);
            if (active) {
              b.classList.add("bg-white","text-black","font-semibold");
              b.classList.remove("bg-white/5","text-white/80");
            } else {
              b.classList.remove("bg-white","text-black","font-semibold");
              b.classList.add("bg-white/5","text-white/80");
            }
          });

          applyView();
        });
      });

      // buttons
      $("btnRefresh").addEventListener("click", loadSnipsets);
      $("btnResetMarks").addEventListener("click", () => {
        localStorage.removeItem(SEEN_KEY);
        localStorage.removeItem(HASH_KEY);
        localStorage.removeItem(UPDATED_KEY);
        loadSnipsets();
      });

      // reveal
      const el = document.querySelector(".reveal");
      if (el) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) el.classList.add("show"); });
        }, { threshold: 0.12 });
        io.observe(el);
      } else {
        document.querySelectorAll(".reveal").forEach(x => x.classList.add("show"));
      }

      loadSnipsets();
    })();
  </script>
</body>
</html>

